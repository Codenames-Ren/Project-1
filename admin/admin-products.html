<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Produk - Toko Rayhan</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans text-gray-800">

  <!-- Header -->
  <header class="flex items-center justify-between bg-gray-800 text-white px-6 py-4 rounded-lg mb-6 shadow">
    <h1 class="text-xl font-bold">Admin Produk - Toko Rayhan</h1>
    <nav class="space-x-4">
      <a href="admin-dashboard.html" class="hover:underline">Dashboard</a>
      <a href="admin-orders.html" class="hover:underline">Pesanan</a>
      <a href="admin-contacts.html" class="hover:underline">Pesan Kontak</a>
      <a href="#" onclick="logoutAdmin()" class="hover:underline">Logout</a>
    </nav>
  </header>

  <!-- Form & Table -->
  <main class="bg-white p-6 rounded-lg shadow">
    <!-- Form -->
    <section class="mb-8">
      <h2 class="text-2xl font-semibold mb-4">Tambah / Edit Produk</h2>
      <form id="productForm" novalidate class="space-y-4">
        <input type="hidden" id="productId" />

        <div>
          <label for="productName" class="block font-medium mb-1">Nama Produk</label>
          <input type="text" id="productName" required minlength="3" 
                 class="w-full border rounded px-3 py-2 focus:ring focus:border-green-600" />
        </div>
        <div>
          <label for="productCategory" class="block font-medium mb-1">Kategori</label>
          <select id="productCategory" required
                  class="w-full border rounded px-3 py-2 focus:ring focus:border-green-600">
            <option value="" disabled selected>Pilih kategori</option>
            <option value="Dapur">Dapur</option>
            <option value="Kamar Mandi">Kamar Mandi</option>
            <option value="Kamar Tidur">Kamar Tidur</option>
            <option value="Ruang Tamu">Ruang Tamu</option>
          </select>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="productStock" class="block font-medium mb-1">Stok</label>
            <input type="number" id="productStock" min="0" required
                   class="w-full border rounded px-3 py-2 focus:ring focus:border-green-600" />
          </div>
          <div>
            <label for="productPrice" class="block font-medium mb-1">Harga (Rp)</label>
            <input type="number" id="productPrice" min="0" step="100" required
                   class="w-full border rounded px-3 py-2 focus:ring focus:border-green-600" />
          </div>
        </div>
        <div>
          <label for="productImage" class="block font-medium mb-1">URL Gambar</label>
          <input type="url" id="productImage" placeholder="https://example.com/img.jpg" required
                 class="w-full border rounded px-3 py-2 focus:ring focus:border-green-600" />
        </div>

        <div class="flex gap-3 mt-4">
          <button type="submit" id="saveBtn"
                  class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded transition">
            Simpan Produk
          </button>
          <button type="button" id="cancelEditBtn" class="hidden bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded transition">
            Batal Edit
          </button>
        </div>

        <div id="formMessage" class="text-sm font-medium mt-2"></div>
        <div id="loadingSpinner" class="text-green-600 text-sm hidden mt-2">Loading...</div>
      </form>
    </section>

    <!-- Table -->
    <section>
      <h2 class="text-2xl font-semibold mb-4">Daftar Produk</h2>
      <div class="overflow-x-auto">
        <table id="productsTable" class="min-w-full table-auto border border-gray-300">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-3 border">ID</th>
              <th class="p-3 border">Nama Produk</th>
              <th class="p-3 border">Kategori</th>
              <th class="p-3 border">Stok</th>
              <th class="p-3 border">Harga (Rp)</th>
              <th class="p-3 border">Gambar</th>
              <th class="p-3 border">Aksi</th>
            </tr>
          </thead>
          <tbody class="text-gray-700">
            <tr><td colspan="7" class="text-center p-4">Memuat data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Script: backend logic tetap sama -->
  <script>
    const apiBase = 'http://localhost:3000/api/products';

    function logoutAdmin(){
      localStorage.removeItem('user');
      localStorage.removeItem('cart');
      localStorage.removeItem('wishlist');
      location.href='/publik/index.html';
    }

    function sanitizeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    const productForm = document.getElementById('productForm');
    const productId = document.getElementById('productId');
    const nameIn = document.getElementById('productName');
    const categoryIn = document.getElementById('productCategory');
    const stockIn = document.getElementById('productStock');
    const priceIn = document.getElementById('productPrice');
    const imageIn = document.getElementById('productImage');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelEditBtn');
    const msgEl = document.getElementById('formMessage');
    const spinner = document.getElementById('loadingSpinner');
    const tbody = document.querySelector('#productsTable tbody');

    function showLoading(on){
      spinner.classList.toggle('hidden', !on);
    }

    async function loadProducts(){
      tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Memuat data...</td></tr>';
      showLoading(true);
      try {
        const res = await fetch(apiBase);
        if(!res.ok) throw new Error('Gagal memuat produk');
        const arr = await res.json();
        if(!arr.length) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Tidak ada produk</td></tr>';
        } else {
          tbody.innerHTML = '';
          arr.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="p-2 border">${p.product_id}</td>
              <td class="p-2 border">${sanitizeHTML(p.product_name)}</td>
              <td class="p-2 border">${sanitizeHTML(p.category||'')}</td>
              <td class="p-2 border">${p.stock}</td>
              <td class="p-2 border">Rp ${Number(p.price).toLocaleString('id-ID')}</td>
              <td class="p-2 border"><img src="${sanitizeHTML(p.image_url)}" alt="" class="h-10 rounded"/></td>
              <td class="p-2 border">
                <div class="inline-flex gap-2">
                  <button onclick="startEdit(${p.product_id})" class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded text-sm">Edit</button>
                  <button onclick="deleteProduct(${p.product_id})" class="bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded text-sm">Hapus</button>
                </div>
              </td>`;
            tbody.appendChild(tr);
          });
        }
      } catch(err){
        tbody.innerHTML = `<tr><td colspan="7" class="text-red-500 text-center p-4">${sanitizeHTML(err.message)}</td></tr>`;
      } finally {
        showLoading(false);
      }
    }

    function clearForm(){
      productId.value = '';
      nameIn.value = '';
      categoryIn.value = '';
      stockIn.value = '';
      priceIn.value = '';
      imageIn.value = '';
      msgEl.textContent = '';
      cancelBtn.classList.add('hidden');
      saveBtn.textContent = 'Simpan Produk';
    }

    async function startEdit(id){
      showLoading(true);
      try {
        const res = await fetch(`${apiBase}/${id}`);
        if(!res.ok) throw new Error('Gagal memuat produk');
        const p = await res.json();
        productId.value = p.product_id;
        nameIn.value = p.product_name;
        categoryIn.value = p.category;
        stockIn.value = p.stock;
        priceIn.value = p.price;
        imageIn.value = p.image_url;
        saveBtn.textContent = 'Update Produk';
        cancelBtn.classList.remove('hidden');
        msgEl.textContent = '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch(e){
        alert(e.message);
      } finally {
        showLoading(false);
      }
    }

    async function deleteProduct(id){
      if(!confirm('Yakin hapus produk ini?')) return;
      showLoading(true);
      try {
        const res = await fetch(`${apiBase}/${id}`, { method:'DELETE' });
        if(!res.ok) throw new Error('Gagal hapus produk');
        loadProducts();
        if(productId.value==id) clearForm();
      } catch(e){
        alert(e.message);
      } finally {
        showLoading(false);
      }
    }

    productForm.addEventListener('submit', async e=>{
      e.preventDefault();
      msgEl.textContent = '';
      const data = {
        product_name: nameIn.value.trim(),
        category: categoryIn.value,
        stock: Number(stockIn.value),
        price: Number(priceIn.value),
        image_url: imageIn.value.trim(),
      };
      if(data.product_name.length<3){
        msgEl.textContent = 'Nama minimal 3 karakter'; msgEl.className='text-red-600';
        return;
      }
      if(!data.category){
        msgEl.textContent = 'Kategori wajib dipilih'; msgEl.className='text-red-600';
        return;
      }
      showLoading(true);
      try {
        const method = productId.value?'PUT':'POST';
        const url = productId.value?`${apiBase}/${productId.value}`:apiBase;
        const res = await fetch(url, {
          method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
        });
        if(!res.ok){
          const body = await res.json();
          throw new Error(body.message||'Gagal menyimpan');
        }
        msgEl.textContent = productId.value?'Produk diperbarui':'Produk ditambahkan';
        msgEl.className = 'text-green-600';
        clearForm();
        loadProducts();
      } catch(err){
        msgEl.textContent = err.message;
        msgEl.className = 'text-red-600';
      } finally {
        showLoading(false);
      }
    });

    cancelBtn.addEventListener('click', clearForm);

    loadProducts();
  </script>

</body>
</html>
