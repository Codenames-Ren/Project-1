<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Daftar Pesanan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
  <header class="bg-gray-800 text-white flex items-center justify-between p-4 shadow-md sticky top-0 z-50">
    <h1 class="text-xl font-bold">Admin Toko Rayhan</h1>
    <nav class="space-x-4 text-sm">
      <a href="admin-dashboard.html" class="hover:underline">Dashboard</a>
      <a href="admin-orders.html" class="underline font-semibold">Pesanan</a>
      <a href="admin-products.html" class="hover:text-blue-400">Produk</a>
      <a href="admin-contacts.html" class="hover:underline">Pesan Kontak</a>
      <a href="#" onclick="logoutAdmin()" class="hover:underline text-red-400">Logout</a>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto mt-8 px-4 mb-16">
    <h2 class="text-3xl font-bold mb-6 text-gray-700">Daftar Pesanan</h2>

    <section class="bg-white p-6 rounded-xl shadow mb-6 flex flex-wrap items-center gap-4">
      <input type="text" id="searchInput" oninput="applyFilter()" placeholder="Cari ID/Nama User" class="border px-3 py-2 text-sm rounded focus:outline-none" />
      <input type="date" id="startDate" class="border rounded px-3 py-2 text-sm focus:outline-none" />
      <input type="date" id="endDate" class="border rounded px-3 py-2 text-sm focus:outline-none" />
      <select id="statusFilter" class="border rounded px-3 py-2 text-sm focus:outline-none">
        <option value="">Semua</option>
        <option value="Pending">Pending</option>
        <option value="Confirmed">Confirmed</option>
        <option value="Processing">Processing</option>
        <option value="Shipped">Shipped</option>
        <option value="Completed">Completed</option>
        <option value="Cancelled">Cancelled</option>
      </select>
      <button onclick="applyFilter()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">Terapkan</button>
      <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">Export Excel</button>
    </section>

    <section class="bg-white rounded-xl shadow overflow-x-auto relative">
      <div id="loading" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden">
        <span class="text-gray-500 text-sm">Memuat data...</span>
      </div>
      <table id="orders-table" class="min-w-full text-sm table-auto">
        <thead class="bg-gray-100 text-gray-700 cursor-pointer">
          <tr>
            <th onclick="sortTable('id')" class="px-4 py-3 border">ID</th>
            <th onclick="sortTable('user_name')" class="px-4 py-3 border">User</th>
            <th onclick="sortTable('created_at')" class="px-4 py-3 border">Tanggal</th>
            <th onclick="sortTable('total')" class="px-4 py-3 border">Total</th>
            <th onclick="sortTable('status')" class="px-4 py-3 border">Status</th>
            <th class="px-4 py-3 border">Aksi</th>
          </tr>
        </thead>
        <tbody id="ordersBody" class="divide-y"></tbody>
      </table>
    </section>

    <div id="pagination" class="mt-6 flex justify-center flex-wrap gap-2"></div>
  </main>

  <script>
    let currentPage = 1, limitPerPage = 10, sortBy = '', sortDir = 'asc';

    const statusBadge = {
      pending: 'bg-orange-100 text-orange-600',
      confirmed: 'bg-blue-100 text-blue-700',
      processing: 'bg-yellow-100 text-yellow-700',
      shipped: 'bg-green-100 text-green-700',
      completed: 'bg-green-100 text-green-800',
      cancelled: 'bg-red-100 text-red-700'
    };

    function logoutAdmin() {
      localStorage.clear();
      location.href = '/publik/index.html';
    }

    function getFilterQuery() {
      const search = document.getElementById('searchInput').value.trim();
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const status = document.getElementById('statusFilter').value;
      const query = [];
      if (search) query.push(`search=${encodeURIComponent(search)}`);
      if (start) query.push(`start=${start}`);
      if (end) query.push(`end=${end}`);
      if (status) query.push(`status=${status}`);
      if (sortBy) query.push(`sort=${sortBy}`);
      if (sortDir) query.push(`dir=${sortDir}`);
      return query.join('&');
    }

    function applyFilter() {
      loadOrders(1);
    }

    function sortTable(field) {
      if (sortBy === field) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
      else {
        sortBy = field;
        sortDir = 'asc';
      }
      loadOrders(1);
    }

    async function loadOrders(page = 1) {
      currentPage = page;
      document.getElementById('loading').classList.remove('hidden');
      try {
        const query = getFilterQuery();
        const res = await fetch(`http://localhost:3000/api/orders?page=${page}&limit=${limitPerPage}&${query}`);
        const data = await res.json();
        const tbody = document.getElementById('ordersBody');
        tbody.innerHTML = '';

        (data.orders || []).forEach(order => {
          const s = (order.status || '').toLowerCase();
          const badgeClass = statusBadge[s] || 'bg-gray-200 text-gray-700';

          let actions = `
            <a href="admin-order-detail.html?id=${order.id}" class="bg-gray-300 hover:bg-gray-400 text-xs px-3 py-1 rounded inline-block">Lihat Detail</a>
          `;

          if (s === 'pending') {
            actions += `<button onclick="updateStatus(${order.id}, 'Confirmed')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded">Konfirmasi</button>`;
          } else if (s === 'confirmed' || s === 'processing') {
            actions += `<button onclick="updateStatus(${order.id}, 'Shipped')" class="bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1 rounded">Kirim</button>`;
          } else if (s === 'shipped') {
            actions += `<button onclick="updateStatus(${order.id}, 'Completed')" class="bg-green-700 hover:bg-green-800 text-white text-xs px-3 py-1 rounded">Selesai</button>`;
          }

          if (s !== 'completed' && s !== 'cancelled') {
            actions += `<button onclick="updateStatus(${order.id}, 'Cancelled')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded">Batalkan</button>`;
          }

          tbody.innerHTML += `
            <tr class="hover:bg-gray-50">
              <td class="border px-4 py-3">${order.id}</td>
              <td class="border px-4 py-3">${order.user_name || 'User #' + order.user_id}</td>
              <td class="border px-4 py-3">${new Date(order.created_at).toLocaleDateString('id-ID')}</td>
              <td class="border px-4 py-3">Rp ${order.total.toLocaleString()}</td>
              <td class="border px-4 py-3"><span class="px-2 py-1 text-xs rounded ${badgeClass}">${order.status}</span></td>
              <td class="border px-4 py-3 space-x-1">${actions}</td>
            </tr>`;
        });

        renderPagination(data.total || 0);
      } catch (err) {
        document.getElementById('ordersBody').innerHTML = '<tr><td colspan="6" class="text-center py-6 text-red-500">Gagal memuat data</td></tr>';
        console.error(err);
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    function renderPagination(totalItems) {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(totalItems / limitPerPage);
      pagination.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = `px-3 py-1 rounded border text-sm ${i === currentPage ? 'bg-gray-800 text-white font-semibold' : 'bg-white hover:bg-gray-100'}`;
        btn.onclick = () => loadOrders(i);
        pagination.appendChild(btn);
      }
    }

    async function updateStatus(id, status) {
      if (!confirm(`Yakin ubah status ke ${status}?`)) return;
      try {
        const res = await fetch(`http://localhost:3000/api/orders/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        if (!res.ok) throw new Error();
        alert('Status diperbarui.');
        loadOrders(currentPage);
      } catch {
        alert('Gagal update status');
      }
    }

    function exportToExcel() {
      const table = document.getElementById("orders-table");
      const wb = XLSX.utils.book_new();
      const ws_data = [["ID", "User", "Tanggal", "Total", "Status"]];

      table.querySelectorAll("tbody tr").forEach(row => {
        const cells = row.querySelectorAll("td");
        ws_data.push([
          cells[0].textContent,
          cells[1].textContent,
          cells[2].textContent,
          cells[3].textContent,
          cells[4].textContent
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, "Orders");
      XLSX.writeFile(wb, "orders-export.xlsx");
    }

    document.addEventListener('DOMContentLoaded', () => {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user.is_admin) return location.href = '/publik/index.html';
      loadOrders();
    });
  </script>
</body>
</html>
