<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detail Pesanan - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">

  <!-- Header Admin -->
  <header class="bg-gray-800 p-4 flex justify-between items-center sticky top-0 z-50 shadow">
    <h1 class="text-xl font-bold">Admin Toko Rayhan</h1>
    <nav class="space-x-4 text-sm">
      <a href="admin-dashboard.html" class="hover:underline">Dashboard</a>
      <a href="admin-orders.html" class="underline font-semibold">Pesanan</a>
      <a href="admin-products.html" class="hover:underline">Produk</a>
      <a href="admin-contacts.html" class="hover:underline">Pesan Kontak</a>
      <a href="#" onclick="logoutAdmin()" class="hover:underline text-red-400">Logout</a>
    </nav>
  </header>

  <div class="max-w-5xl mx-auto p-6 mt-6">
    <!-- Breadcrumb + Back Button -->
    <div class="flex justify-between items-center text-sm text-gray-300 mb-4">
      <nav class="space-x-1">
        <a href="admin-dashboard.html" class="hover:underline text-gray-400">Dashboard</a> &gt;
        <a href="admin-orders.html" class="hover:underline text-gray-400">Pesanan</a> &gt;
        <span class="text-white">Detail</span>
      </nav>
      <button onclick="history.back()" class="bg-gray-700 hover:bg-gray-600 text-sm px-4 py-1 rounded text-white">
        ‚Üê Kembali
      </button>
    </div>

    <h2 class="text-3xl font-bold mb-6 text-center text-white">Detail Pesanan</h2>

    <!-- Order Info -->
    <div id="orderInfo" class="bg-gray-800 rounded-xl shadow p-6 mb-6 space-y-2 text-sm sm:text-base"></div>

    <!-- Items Table -->
    <div class="bg-gray-800 rounded-xl shadow overflow-auto mb-6">
      <table class="min-w-full divide-y divide-gray-700 text-sm">
        <thead class="bg-gray-700 text-gray-100">
          <tr>
            <th class="px-4 py-2 text-left font-medium">Nama Produk</th>
            <th class="px-4 py-2 text-left font-medium">Jumlah</th>
            <th class="px-4 py-2 text-left font-medium">Harga</th>
            <th class="px-4 py-2 text-left font-medium">Subtotal</th>
          </tr>
        </thead>
        <tbody id="itemsTable" class="divide-y divide-gray-700"></tbody>
      </table>
    </div>

    <!-- Summary -->
    <div id="summary" class="bg-gray-800 rounded-xl shadow p-6 mb-6 space-y-1 text-sm sm:text-base"></div>

    <!-- Status Update -->
    <div class="bg-gray-800 rounded-xl shadow p-6 flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
      <label for="statusSelect" class="font-medium">Ubah Status:</label>
      <select id="statusSelect" class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
        <option value="pending">Pending</option>
        <option value="confirmed">Confirmed</option>
        <option value="processing">Processing</option>
        <option value="shipped">Shipped</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </select>
      <button id="updateStatusBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium">
        Update Status
      </button>
    </div>
  </div>

  <script>
    const apiBaseUrl = 'http://localhost:3000/api/orders';
    const orderId = new URLSearchParams(window.location.search).get('id');

    if (!orderId) {
      document.body.innerHTML = '<div class="text-center p-10 text-red-400 font-bold">Order ID tidak ditemukan.</div>';
      throw new Error('Order ID tidak ditemukan');
    }

    function logoutAdmin() {
      localStorage.clear();
      window.location.href = '/publik/index.html';
    }

    function formatRupiah(value) {
      return 'Rp ' + (value || 0).toLocaleString('id-ID');
    }

    function getStatusBadge(status) {
      const s = (status || '').toLowerCase();
      const base = "px-2 py-1 text-xs rounded font-semibold";
      if (s === 'pending') return `<span class="${base} bg-orange-500 text-white">Pending</span>`;
      if (s === 'confirmed') return `<span class="${base} bg-blue-500 text-white">Confirmed</span>`;
      if (s === 'processing') return `<span class="${base} bg-yellow-500 text-white">Processing</span>`;
      if (s === 'shipped') return `<span class="${base} bg-green-500 text-white">Shipped</span>`;
      if (s === 'completed') return `<span class="${base} bg-emerald-600 text-white">Completed</span>`;
      if (s === 'cancelled') return `<span class="${base} bg-red-500 text-white">Cancelled</span>`;
      return `<span class="${base} bg-gray-500 text-white">${status || '-'}</span>`;
    }

    async function fetchOrderDetail() {
      try {
        const res = await fetch(`${apiBaseUrl}/${orderId}`);
        if (!res.ok) throw new Error('Gagal mengambil data order');
        const order = await res.json();
        renderOrderDetail(order);
      } catch (error) {
        document.body.innerHTML = `<div class="text-red-500 p-6 text-center">Error: ${error.message}</div>`;
      }
    }

    function renderOrderDetail(order) {
      const method = (order.payment_method || '').toLowerCase();
      let paymentDetails = '';
      if (method === 'transfer') {
        paymentDetails = `
          <p><strong>Bank:</strong> ${order.payment_details?.bank_name || '-'}</p>
          <p><strong>No. Virtual Account:</strong> ${order.payment_details?.virtual_account || '-'}</p>
          <p><strong>Jumlah Bayar:</strong> ${formatRupiah(order.total)}</p>
        `;
      } else if (method === 'ewallet') {
        paymentDetails = `
          <p><strong>E-Wallet:</strong> ${order.payment_details?.wallet_name || '-'}</p>
          <p><strong>No. HP Tujuan:</strong> ${order.payment_details?.phone_number || '-'}</p>
          <p><strong>Jumlah Bayar:</strong> ${formatRupiah(order.total)}</p>
        `;
      } else if (method === 'cod') {
        paymentDetails = `<p><strong>Metode Pembayaran:</strong> Cash on Delivery (COD)</p>`;
      }

      document.getElementById('orderInfo').innerHTML = `
        <p><strong>Nama Pelanggan:</strong> ${order.customer_name}</p>
        <p><strong>Telepon:</strong> ${order.customer_phone}</p>
        <p><strong>Alamat:</strong> ${order.customer_address}</p>
        <p><strong>Metode Pengiriman:</strong> ${order.shipping_method || '-'} (${formatRupiah(order.shipping_cost)})</p>
        <p><strong>Metode Pembayaran:</strong> ${order.payment_method}</p>
        ${paymentDetails}
        <p><strong>Status Pesanan:</strong> ${getStatusBadge(order.status)}</p>
      `;

      const tbody = document.getElementById('itemsTable');
      tbody.innerHTML = '';
      order.items.forEach(item => {
        const subtotal = item.price * item.quantity;
        tbody.innerHTML += `
          <tr>
            <td class="px-4 py-2">${item.product_name}</td>
            <td class="px-4 py-2">${item.quantity}</td>
            <td class="px-4 py-2">${formatRupiah(item.price)}</td>
            <td class="px-4 py-2">${formatRupiah(subtotal)}</td>
          </tr>
        `;
      });

      const tax = order.subtotal * 0.10;
      const total = order.subtotal + tax + order.shipping_cost;
      document.getElementById('summary').innerHTML = `
        <p><strong>Subtotal:</strong> ${formatRupiah(order.subtotal)}</p>
        <p><strong>Tax (10%):</strong> ${formatRupiah(tax)}</p>
        <p><strong>Biaya Pengiriman:</strong> ${formatRupiah(order.shipping_cost)}</p>
        <p><strong>Total:</strong> <span class="font-bold text-green-400">${formatRupiah(total)}</span></p>
      `;

      document.getElementById('statusSelect').value = order.status;
    }

    async function updateStatus() {
      const newStatus = document.getElementById('statusSelect').value;
      try {
        const res = await fetch(`${apiBaseUrl}/${orderId}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus }),
        });
        if (!res.ok) throw new Error(await res.text());
        alert('Status berhasil diperbarui!');
        fetchOrderDetail();
      } catch (err) {
        alert('Gagal memperbarui status: ' + err.message);
      }
    }

    document.getElementById('updateStatusBtn').addEventListener('click', updateStatus);
    fetchOrderDetail();
  </script>

</body>
</html>
