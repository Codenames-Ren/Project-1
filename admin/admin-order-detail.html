<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detail Pesanan - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-700">Detail Pesanan</h1>

    <!-- Order Info -->
    <div id="orderInfo" class="bg-white rounded-xl shadow p-6 mb-6 space-y-2 text-sm sm:text-base"></div>

    <!-- Items Table -->
    <div class="bg-white rounded-xl shadow overflow-auto mb-6">
      <table class="min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left font-medium text-gray-600">Nama Produk</th>
            <th class="px-4 py-2 text-left font-medium text-gray-600">Jumlah</th>
            <th class="px-4 py-2 text-left font-medium text-gray-600">Harga</th>
            <th class="px-4 py-2 text-left font-medium text-gray-600">Subtotal</th>
          </tr>
        </thead>
        <tbody id="itemsTable" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>

    <!-- Summary -->
    <div id="summary" class="bg-white rounded-xl shadow p-6 mb-6 space-y-1 text-sm sm:text-base"></div>

    <!-- Status Update -->
    <div class="bg-white rounded-xl shadow p-6 flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
      <label for="statusSelect" class="font-medium">Ubah Status:</label>
      <select id="statusSelect" class="border border-gray-300 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="pending">Pending</option>
        <option value="confirmed">Confirmed</option>
        <option value="processing">Processing</option>
        <option value="shipped">Shipped</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </select>
      <button id="updateStatusBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium">Update Status</button>
    </div>
  </div>

  <script>
    const apiBaseUrl = 'http://localhost:3000/api/orders';
    const orderId = new URLSearchParams(window.location.search).get('id');

    if (!orderId) {
      document.body.innerHTML = '<div class="text-center p-10 text-red-600 font-bold">Order ID tidak ditemukan.</div>';
      throw new Error('Order ID tidak ditemukan');
    }

    function formatRupiah(value) {
      return 'Rp ' + (value || 0).toLocaleString('id-ID');
    }

    function getStatusBadge(status) {
      const s = (status || '').toLowerCase();
      if (s === 'pending') return '<span class="px-2 py-1 text-xs rounded bg-orange-100 text-orange-600">Pending</span>';
      if (s === 'confirmed') return '<span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">Confirmed</span>';
      if (s === 'shipped') return '<span class="px-2 py-1 text-xs rounded bg-green-100 text-green-700">Shipped</span>';
      if (s === 'cancelled') return '<span class="px-2 py-1 text-xs rounded bg-red-100 text-red-700">Cancelled</span>';
      if (s === 'completed') return '<span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">Completed</span>';
      return `<span class="px-2 py-1 text-xs rounded bg-gray-200 text-gray-700">${status || '-'}</span>`;
    }

    async function fetchOrderDetail() {
      try {
        const res = await fetch(`${apiBaseUrl}/${orderId}`);
        if (!res.ok) throw new Error('Gagal mengambil data order');
        const order = await res.json();
        renderOrderDetail(order);
      } catch (error) {
        document.body.innerHTML = `<div class="text-red-600 p-6 text-center">Error: ${error.message}</div>`;
      }
    }

    function renderOrderDetail(order) {
      // RENDER INFO ORDER + PAYMENT DETAILS
      const method = (order.payment_method || '').toLowerCase();
      let paymentDetails = '';
      if (method === 'transfer') {
        paymentDetails = `
          <p><strong>Bank:</strong> ${order.payment_details?.bank_name || '-'}</p>
          <p><strong>No. Virtual Account:</strong> ${order.payment_details?.virtual_account || '-'}</p>
          <p><strong>Jumlah Bayar:</strong> ${formatRupiah(order.total)}</p>
        `;
      } else if (method === 'ewallet') {
        paymentDetails = `
          <p><strong>E-Wallet:</strong> ${order.payment_details?.wallet_name || '-'}</p>
          <p><strong>No. HP Tujuan:</strong> ${order.payment_details?.phone_number || '-'}</p>
          <p><strong>Jumlah Bayar:</strong> ${formatRupiah(order.total)}</p>
        `;
      } else if (method === 'cod') {
        paymentDetails = `<p><strong>Metode Pembayaran:</strong> Cash on Delivery (COD)</p>`;
      }

      document.getElementById('orderInfo').innerHTML = `
        <p><strong>Nama Pelanggan:</strong> ${order.customer_name}</p>
        <p><strong>Telepon:</strong> ${order.customer_phone}</p>
        <p><strong>Alamat:</strong> ${order.customer_address}</p>
        <p><strong>Metode Pengiriman:</strong> ${order.shipping_method || '-'} (${formatRupiah(order.shipping_cost)})</p>
        <p><strong>Metode Pembayaran:</strong> ${order.payment_method}</p>
        ${paymentDetails}
        <p><strong>Status Pesanan:</strong> ${getStatusBadge(order.status)}</p>
      `;

      // RENDER TABEL ITEM
      const tbody = document.getElementById('itemsTable');
      tbody.innerHTML = '';
      order.items.forEach(item => {
        const subtotal = item.price * item.quantity;
        tbody.innerHTML += `
          <tr>
            <td class="px-4 py-2">${item.product_name}</td>
            <td class="px-4 py-2">${item.quantity}</td>
            <td class="px-4 py-2">${formatRupiah(item.price)}</td>
            <td class="px-4 py-2">${formatRupiah(subtotal)}</td>
          </tr>
        `;
      });

      // RENDER RINGKASAN
      const tax = order.subtotal * 0.12;
      const total = order.subtotal + tax + order.shipping_cost;
      document.getElementById('summary').innerHTML = `
        <p><strong>Subtotal:</strong> ${formatRupiah(order.subtotal)}</p>
        <p><strong>Tax (12%):</strong> ${formatRupiah(tax)}</p>
        <p><strong>Biaya Pengiriman:</strong> ${formatRupiah(order.shipping_cost)}</p>
        <p><strong>Total:</strong> <span class="font-bold text-green-700">${formatRupiah(total)}</span></p>
      `;

      document.getElementById('statusSelect').value = order.status;
    }

    async function updateStatus() {
      const newStatus = document.getElementById('statusSelect').value;
      try {
        const res = await fetch(`${apiBaseUrl}/${orderId}/status`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: newStatus }),
        });
        if (!res.ok) throw new Error(await res.text());
        alert('Status berhasil diperbarui!');
        fetchOrderDetail();
      } catch (err) {
        alert('Gagal memperbarui status: ' + err.message);
      }
    }

    document.getElementById('updateStatusBtn').addEventListener('click', updateStatus);
    fetchOrderDetail();
  </script>

</body>
</html>
