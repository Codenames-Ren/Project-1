<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toko Perabot Rayhan</title>
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <div class="logo">Toko<span>Rayhan</span></div>
        <ul class="nav-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="products.html">Products</a></li>
          <li><a href="collections.html">Collections</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
        <div class="nav-icons">
          <div class="search-icon" title="Search"><i class="fa-light fa-magnifying-glass"></i></div>
          <div class="wishlist-icon" onclick="openWishlistModal()" title="Wishlist">
            <i class="fa-light fa-heart"></i>
            <span class="wishlist-count">0</span>
          </div>
          <div class="cart-icon" onclick="openCartModal()" title="Shopping Cart">
            <i class="fa-light fa-cart-shopping-fast"></i>
            <span class="cart-count">0</span>
          </div>
          <div class="user-icon" onclick="toggleModal('loginModal')" title="User Account">
            <i class="fa-light fa-user"></i>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main id="homepage">
    <!-- Hero -->
    <section class="hero-slider">
      <div class="slides">
        <div class="slide" style="background-image: url(/images/home.avif);"></div>
      </div>
    </section>

    <!-- Categories Section -->
    <section class="categories">
      <div class="container">
        <h2 class="section-title">Browse by Category</h2>
        <div class="category-grid">
          <div class="category-card" onclick="window.location.href='products.html'">
            <div class="category-img">
              <img src="/product/category/bathroom.jpg" alt="Bathroom">
            </div>
            <div class="category-info">
              <h3>Bathroom</h3>
              <p>Rak Cermin, Rak Sabun, Shower, and more</p>
            </div>
          </div>
          <div class="category-card" onclick="window.location.href='products.html'">
            <div class="category-img">
              <img src="/product/category/kitchen.jpg" alt="Kitchen">
            </div>
            <div class="category-info">
              <h3>Kitchen</h3>
              <p>Pisau, Teko Listrik, Microwave, and more</p>
            </div>
          </div>
          <div class="category-card" onclick="window.location.href='products.html'">
            <div class="category-img">
              <img src="/product/category/sittingroom.jpg" alt="Sitting Room">
            </div>
            <div class="category-info">
              <h3>Sitting Room</h3>
              <p>Rumah Lampu, Karpet Plastik, Lampu, and more</p>
            </div>
          </div>
          <div class="category-card" onclick="window.location.href='products.html'">
            <div class="category-img">
              <img src="/product/category/Bedroom.jpg" alt="Bedroom">
            </div>
            <div class="category-info">
              <h3>Bedroom</h3>
              <p>Meja Lipat, Lampu Belajar, Standing Mirror, and more</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Featured Products Section -->
    <section class="products">
      <div class="container">
        <h2 class="section-title">Featured Products</h2>
        <div class="product-grid">

          <!-- Product Card 1 -->
          <div class="product-card" onclick="goToProductDetail(1)">
            <div class="product-img">
              <img src="/product/dapur/blender.jpg" alt="blender">
              <span class="product-tag">New</span>
            </div>
            <div class="product-info">
              <h3>Blender Kapsul</h3>
              <div class="product-price">Rp 89.000</div>
              <div class="product-actions">
                <button class="add-to-cart-btn" data-product-id="1" data-product-name="Blender Kapsul" data-price="89000" data-image="/product/dapur/blender.jpg">Add to Cart</button>
                <button class="add-to-wishlist-btn" data-product-id="1" data-product-name="Blender Kapsul" data-price="89000" data-image="/product/dapur/blender.jpg"><i class="far fa-heart"></i></button>
              </div>
            </div>
          </div>

          <!-- Product Card 2 -->
          <div class="product-card" onclick="goToProductDetail(2)">
            <div class="product-img">
              <img src="/product/kamar tidur/cermin-kamar.jpg" alt="cermin-kamar">
            </div>
            <div class="product-info">
              <h3>Standing Mirror</h3>
              <div class="product-price">Rp 150.000</div>
              <div class="product-actions">
                <button class="add-to-cart-btn" data-product-id="2" data-product-name="Standing Mirror" data-price="150000" data-image="/product/kamar tidur/cermin-kamar.jpg">Add to Cart</button>
                <button class="add-to-wishlist-btn" data-product-id="2" data-product-name="Standing Mirror" data-price="150000" data-image="/product/kamar tidur/cermin-kamar.jpg"><i class="far fa-heart"></i></button>
              </div>
            </div>
          </div>

          <!-- Product Card 3 -->
          <div class="product-card" onclick="goToProductDetail(3)">
            <div class="product-img">
              <img src="/product/kamarmandi/botol-sabun.jpg" alt="botol-sabun">
            </div>
            <div class="product-info">
              <h3>Botol Sabun Cair</h3>
              <div class="product-price">Rp 10.000</div>
              <div class="product-actions">
                <button class="add-to-cart-btn" data-product-id="3" data-product-name="Botol Sabun Cair" data-price="10000" data-image="/product/kamarmandi/botol-sabun.jpg">Add to Cart</button>
                <button class="add-to-wishlist-btn" data-product-id="3" data-product-name="Botol Sabun Cair" data-price="10000" data-image="/product/kamarmandi/botol-sabun.jpg"><i class="far fa-heart"></i></button>
              </div>
            </div>
          </div>

          <!-- Product Card 4 -->
          <div class="product-card" onclick="goToProductDetail(4)">
            <div class="product-img">
              <img src="/product/ruang-tamu/jam-dinding.jpg" alt="jam-dinding">
            </div>
            <div class="product-info">
              <h3>Jam Dinding</h3>
              <div class="product-price">Rp 50.000</div>
              <div class="product-actions">
                <button class="add-to-cart-btn" data-product-id="4" data-product-name="Jam Dinding" data-price="50000" data-image="/product/ruang-tamu/jam-dinding.jpg">Add to Cart</button>
                <button class="add-to-wishlist-btn" data-product-id="4" data-product-name="Jam Dinding" data-price="50000" data-image="/product/ruang-tamu/jam-dinding.jpg"><i class="far fa-heart"></i></button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Features Section -->
    <section class="features">
      <div class="container">
        <h2 class="section-title">Why Choose Us</h2>
        <div class="features-grid">
          <div class="feature-card">
            <div class="feature-icon">üöö</div>
            <h3>Free Delivery</h3>
            <p>Free shipping on all orders over $500</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">üõ†Ô∏è</div>
            <h3>Assembly Service</h3>
            <p>Professional assembly available</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">‚è±Ô∏è</div>
            <h3>30-Day Returns</h3>
            <p>Easy returns within 30 days</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">üèÜ</div>
            <h3>Quality Guarantee</h3>
            <p>5-year warranty on all products</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal for Login -->
  <div id="loginModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="toggleModal('loginModal')">&times;</span>
      <h2>Login</h2>
      <form id="loginForm" method="post">
        <div class="form-group">
          <input type="email" id="loginEmail" placeholder="Email" required>
        </div>
        <div class="form-group">
          <input type="password" id="loginPassword" placeholder="Password" required>
        </div>
        <button type="submit">Login</button>
      </form>
      <p class="switch-auth">Belum punya akun? <a href="#" id="registerLink">Register</a></p>
    </div>
  </div>

  <!-- Modal for Register -->
  <div id="registerModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="toggleModal('registerModal')">&times;</span>
      <h2>Register</h2>
      <form id="registerForm" method="post">
        <div class="form-group">
          <input type="text" id="registerName" placeholder="Nama Lengkap" required>
        </div>
        <div class="form-group">
          <input type="email" id="registerEmail" placeholder="Email" required>
        </div>
        <div class="form-group">
          <input type="password" id="registerPassword" placeholder="Password" required>
        </div>
        <div class="form-group">
          <input type="text" id="registerPhone" placeholder="Nomor Telepon" required>
        </div>
        <div class="form-group">
          <textarea id="registerAddress" placeholder="Alamat" required></textarea>
        </div>
        <button type="submit">Register</button>
      </form>
      <p class="switch-auth">Sudah punya akun? <a href="#" id="loginLink">Login</a></p>
    </div>
  </div>

    <!-- Cart Popup -->
  <div id="cartPopup" class="popup hidden">
    <h3>Keranjang Saya</h3>
    <div id="cartItems"></div>
  </div>

  <!-- Wishlist Popup -->
  <div id="wishlistPopup" class="popup hidden">
    <h3>Wishlist Saya</h3>
    <div id="wishlistItems"></div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-column">
          <h3>Toko Rayhan</h3>
          <p>Premium furniture for modern living.</p>
        </div>
        <div class="footer-column">
          <h3>All Products</h3>
          <ul class="footer-links">
            <li><a href="products.html">Living Room</a></li>
            <li><a href="products.html">Bedroom</a></li>
            <li><a href="products.html">Dining Room</a></li>
            <li><a href="products.html">Office</a></li>
          </ul>
        </div>
        <div class="footer-column">
          <h3>Information</h3>
          <ul class="footer-links">
            <li><a href="about.html">About Us</a></li>
            <li><a href="contact.html">Contact Us</a></li>
            <li><a href="#">Blog</a></li>
            <li><a href="#">FAQs</a></li>
            <li><a href="#">Privacy Policy</a></li>
          </ul>
        </div>
        <div class="footer-column">
          <h3>Customer Service</h3>
          <ul class="footer-links">
            <li><a href="#">My Account</a></li>
            <li><a href="#">Track Order</a></li>
            <li><a href="#">Returns & Exchanges</a></li>
            <li><a href="#">Shipping Policy</a></li>
            <li><a href="#">Warranty</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Toko Perabot Rayhan. All rights reserved.</p>
      </div>
    </div>
  </footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // ===================== Modal Handling =====================
function toggleModal(modalId = 'loginModal') {
  const userStr = localStorage.getItem('user');
  if (userStr) {
    window.location.href = "account.html";
  } else {
    const modal = document.getElementById(modalId);
    if (modal) modal.classList.toggle('hidden');
  }
}

function showLogin() {
  document.getElementById("loginModal")?.classList.remove("hidden");
  document.getElementById("registerModal")?.classList.add("hidden");
}

function showRegister() {
  document.getElementById("registerModal")?.classList.remove("hidden");
  document.getElementById("loginModal")?.classList.add("hidden");
}

// ===================== Count Update =====================
function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const cartCountElement = document.querySelector('.cart-count');
  if (cartCountElement) cartCountElement.textContent = cart.length;
}

function updateWishlistCount() {
  const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
  const wishlistCountElement = document.querySelector('.wishlist-count');
  if (wishlistCountElement) wishlistCountElement.textContent = wishlist.length;
}

// ===================== User Data Fetching =====================
async function fetchAndStoreUserData(userId) {
  try {
    const [cartRes, wishlistRes] = await Promise.all([
      fetch(`http://localhost:3000/api/cart/${userId}`),
      fetch(`http://localhost:3000/api/wishlist/${userId}`)
    ]);

    if (!cartRes.ok || !wishlistRes.ok) throw new Error('Gagal fetch cart/wishlist');

    const cart = await cartRes.json();
    const wishlist = await wishlistRes.json();

    localStorage.setItem('cart', JSON.stringify(cart));
    localStorage.setItem('wishlist', JSON.stringify(wishlist));

    updateCartCount();
    updateWishlistCount();
  } catch (err) {
    console.error('Fetch user data error:', err);
  }
}

// ===================== Add to Cart & Wishlist =====================
function addToCart(product) {
  const userStr = localStorage.getItem('user');
  if (!userStr) return Swal.fire({ icon: "warning", title: "Login Diperlukan", text: "Silakan login terlebih dahulu." });

  const user = JSON.parse(userStr);
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  const exists = cart.find(p => p.product_id === product.product_id);

  if (exists) {
    return Swal.fire({ icon: "info", title: "Sudah Ada", text: `\"${product.product_name}\" sudah di keranjang.` });
  }

  product.quantity = 1;
  if (product.image) {
    product.image_url = product.image;
    delete product.image;
  }
  cart.push(product);
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartCount();

  fetch('http://localhost:3000/api/cart', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ...product, user_id: user.id })
  }).catch(console.error);

  Swal.fire({ icon: "success", title: "Ditambahkan ke Keranjang!", text: `\"${product.product_name}\" telah ditambahkan.` });
  }

function addToWishlist(product) {
  const userStr = localStorage.getItem('user');
  if (!userStr) return Swal.fire({ icon: "warning", title: "Login Diperlukan", text: "Silakan login terlebih dahulu." });

  const user = JSON.parse(userStr);
  let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
  const exists = wishlist.find(p => p.product_id === product.product_id);

  if (exists) {
    return Swal.fire({ icon: "info", title: "Sudah Ada", text: `\"${product.product_name}\" sudah di wishlist.` });
  }

  if (product.image) {
    product.image_url = product.image;
    delete product.image;
  }
  wishlist.push(product);
  localStorage.setItem('wishlist', JSON.stringify(wishlist));
  updateWishlistCount();

  fetch('http://localhost:3000/api/wishlist', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ...product, user_id: user.id })
  }).catch(console.error);

  Swal.fire({ icon: "success", title: "Ditambahkan ke Wishlist!", text: `\"${product.product_name}\" telah ditambahkan.` });
}

// ===================== Pop-up Handling =====================
async function openCartModal() {
  const userStr = localStorage.getItem('user');
  if (!userStr) return Swal.fire({ icon: 'warning', title: 'Login Diperlukan', text: 'Silakan login dulu.' });

  try {
    const user = JSON.parse(userStr);
    const res = await fetch(`http://localhost:3000/api/cart/${user.id}`);
    if (!res.ok) throw new Error('Gagal fetch cart');

    const cart = await res.json();
    const container = document.getElementById('cartItems');
    container.innerHTML = cart.length === 0 ? '<p class="text-gray-500">Keranjang kosong.</p>' : '';

    cart.forEach(item => {
      const el = document.createElement('div');
      el.className = 'popup-item';
      el.innerHTML = `
        <img src="${item.image_url}" alt="${item.product_name}" />
        <span>${item.product_name}</span>
        <small>Rp ${Number(item.price).toLocaleString()}</small>
      `;
      container.appendChild(el);
    });

    document.getElementById('wishlistPopup')?.classList.add('hidden');
    document.getElementById('cartPopup')?.classList.toggle('hidden');
  } catch (error) {
    console.error(error);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Gagal membuka keranjang.' });
  }
}

async function openWishlistModal() {
  const userStr = localStorage.getItem('user');
  if (!userStr) return Swal.fire({ icon: 'warning', title: 'Login Diperlukan', text: 'Silakan login dulu.' });

  try {
    const user = JSON.parse(userStr);
    const res = await fetch(`http://localhost:3000/api/wishlist/${user.id}`);
    if (!res.ok) throw new Error('Gagal fetch wishlist');

    const wishlist = await res.json();
    const container = document.getElementById('wishlistItems');
    container.innerHTML = wishlist.length === 0 ? '<p class="text-gray-500">Wishlist kosong.</p>' : '';

    wishlist.forEach(item => {
      const el = document.createElement('div');
      el.className = 'popup-item';
      el.innerHTML = `
        <img src="${item.image_url}" alt="${item.product_name}" />
        <span>${item.product_name}</span>
        <small>Rp ${Number(item.price).toLocaleString()}</small>
      `;
      container.appendChild(el);
    });

    document.getElementById('cartPopup')?.classList.add('hidden');
    document.getElementById('wishlistPopup')?.classList.toggle('hidden');
  } catch (error) {
    console.error(error);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Gagal membuka wishlist.' });
  }
}

// ===================== Form Handling =====================
document.getElementById('loginForm')?.addEventListener('submit', async function (e) {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;

  try {
    const res = await fetch('http://localhost:3000/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();
    if (res.ok) {
      localStorage.setItem('user', JSON.stringify(data.user));
      await fetchAndStoreUserData(data.user.id);
      Swal.fire({ title: "Success!", text: "Login Berhasil!", icon: "success" });
      document.getElementById("loginModal")?.classList.add("hidden");
    } else {
      Swal.fire({ icon: "error", title: "Oops...", text: data.message || "Login gagal!" });
    }
  } catch (err) {
    console.error(err);
    Swal.fire({ icon: "error", title: "Error", text: "Gagal melakukan login." });
  }
});

document.getElementById('registerForm')?.addEventListener('submit', async function (e) {
  e.preventDefault();
  const name = document.getElementById('registerName').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  const password = document.getElementById('registerPassword').value;
  const phone = document.getElementById('registerPhone').value.trim();
  const address = document.getElementById('registerAddress').value.trim();

  try {
    const res = await fetch('http://localhost:3000/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password, phone, address })
    });

    const data = await res.json();
    if (res.ok) {
      Swal.fire({ title: "Success!", text: "Registrasi Berhasil! Silakan login.", icon: "success" });
      showLogin();
      document.getElementById("registerModal")?.classList.add("hidden");
    } else {
      Swal.fire({ icon: "error", title: "Gagal Registrasi", text: data.message || "Terjadi kesalahan." });
    }
  } catch (err) {
    console.error(err);
    Swal.fire({ icon: "error", title: "Error", text: "Gagal melakukan registrasi." });
  }
});

// ===================== DOM Ready =====================
document.addEventListener('DOMContentLoaded', () => {
  const userStr = localStorage.getItem('user');
  if (userStr) {
    try {
      const user = JSON.parse(userStr);
      fetchAndStoreUserData(user.id);
    } catch {}
  }

  updateCartCount();
  updateWishlistCount();

  document.querySelectorAll('.add-to-cart-btn').forEach(button => {
    button.addEventListener('click', function (e) {
      e.stopPropagation();
      const product = {
        product_id: parseInt(this.dataset.productId),
        product_name: this.dataset.productName,
        price: parseInt(this.dataset.price),
        image: this.dataset.image
      };
      addToCart(product);
    });
  });

  document.querySelectorAll('.add-to-wishlist-btn').forEach(button => {
    button.addEventListener('click', function (e) {
      e.stopPropagation();
      const product = {
        product_id: parseInt(this.dataset.productId),
        product_name: this.dataset.productName,
        price: parseInt(this.dataset.price),
        image: this.dataset.image
      };
      addToWishlist(product);
    });
  });
});

// ===================== Misc Event =====================
document.addEventListener('keydown', function (e) {
  if (e.key === 'Escape') {
    document.getElementById("loginModal")?.classList.add("hidden");
    document.getElementById("registerModal")?.classList.add("hidden");
  }
});

document.getElementById('registerLink')?.addEventListener('click', function (e) {
  e.preventDefault();
  showRegister();
});

document.getElementById('loginLink')?.addEventListener('click', function (e) {
  e.preventDefault();
  showLogin();
});

// ===================== Navigation =====================
function goToProductDetail(productId) {
  window.location.href = `./product-detail.html?id=${productId}`;
}
</script>

</body>
</html>