<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detail Produk</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .product-detail {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }
    .product-image {
      flex: 1 1 300px;
      max-width: 400px;
    }
    .product-image img {
      width: 100%;
      border-radius: 8px;
    }
    .product-info {
      flex: 1 1 300px;
    }
    h1 {
      margin-top: 0;
    }
    .price {
      font-size: 1.5rem;
      color: #e74c3c;
      margin: 1rem 0;
    }
    button {
      cursor: pointer;
      background-color: #3498db;
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 6px;
      margin-right: 10px;
      font-size: 1rem;
    }
    button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>

  <button onclick="window.history.back()">‚Üê Kembali</button>

  <div id="product-detail">
    <img id="product-image" src="" alt="Gambar Produk" style="max-width: 300px;" />
    <h2 id="product-name">Nama Produk</h2>
    <p id="product-price">Harga Produk</p>
    <p id="product-description">Deskripsi Produk</p>
  </div>

<script>
  const apiBase = 'http://localhost:3000/api';

  // Fungsi ambil query param id
// Ambil ID produk dari URL
  function getProductIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get("id");
  }

  async function loadProductDetail() {
    const productId = getProductIdFromURL();
    if (!productId) {
      document.getElementById("product-detail").innerHTML = "<p>ID produk tidak ditemukan.</p>";
      return;
    }

    try {
      const res = await fetch(`http://localhost:3000/api/products/${productId}`);
      const product = await res.json();

      if (!res.ok) throw new Error(product.message || "Gagal mengambil data produk.");

      document.getElementById("product-name").textContent = product.name;
      document.getElementById("product-price").textContent = `Rp ${product.price.toLocaleString("id-ID")}`;
      document.getElementById("product-image").src = product.image_url;
      document.getElementById("product-description").textContent = product.description;

    } catch (err) {
      document.getElementById("product-detail").innerHTML = `<p>${err.message}</p>`;
    }
  }

  document.addEventListener("DOMContentLoaded", loadProductDetail);

  // Render detail produk di halaman
  function renderProductDetail(product) {
    const container = document.getElementById('productDetail');
    container.innerHTML = `
      <div class="product-image">
        <img src="${product.image_url || 'https://via.placeholder.com/400'}" alt="${product.product_name}" />
      </div>
      <div class="product-info">
        <h1>${product.product_name}</h1>
        <p class="price">Rp ${product.price.toLocaleString('id-ID')}</p>
        <p>${product.description || 'Deskripsi produk tidak tersedia.'}</p>
        <div>
          <button id="btnAddToCart">Tambah ke Keranjang</button>
          <button id="btnAddToWishlist">Tambah ke Wishlist</button>
        </div>
      </div>
    `;

    // Pasang event listener tombol
    document.getElementById('btnAddToCart').addEventListener('click', () => addToCart(product));
    document.getElementById('btnAddToWishlist').addEventListener('click', () => addToWishlist(product));
  }

  // Fungsi tambah ke cart (pakai API dan localStorage)
  async function addToCart(product) {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      Swal.fire({
        icon: 'warning',
        title: 'Login Diperlukan',
        text: 'Silakan login terlebih dahulu untuk menambahkan ke keranjang.'
      });
      return;
    }

    const cartData = {
      user_id: user.id,
      product_id: product.product_id,
      product_name: product.product_name,
      price: product.price,
      image_url: product.image_url,
      quantity: 1
    };

    try {
      const response = await fetch(`${apiBase}/cart`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cartData)
      });
      const result = await response.json();

      if (response.ok) {
        Swal.fire({
          icon: 'success',
          title: 'Berhasil!',
          text: `"${product.product_name}" ditambahkan ke keranjang!`
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Gagal!',
          text: result.message || 'Gagal menambahkan ke keranjang.'
        });
      }
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: 'Terjadi Kesalahan',
        text: error.message
      });
    }
  }

  // Fungsi tambah ke wishlist (API dan localStorage)
  async function addToWishlist(product) {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      Swal.fire({
        icon: 'warning',
        title: 'Login Diperlukan',
        text: 'Silakan login terlebih dahulu untuk menambahkan ke wishlist.'
      });
      return;
    }

    const wishlistData = {
      user_id: user.id,
      product_id: product.product_id,
      product_name: product.product_name,
      price: product.price,
      image_url: product.image_url
    };

    try {
      const response = await fetch(`${apiBase}/wishlist`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(wishlistData)
      });
      const result = await response.json();

      if (response.ok) {
        Swal.fire({
          icon: 'success',
          title: 'Berhasil!',
          text: `"${product.product_name}" ditambahkan ke wishlist!`
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Gagal!',
          text: result.message || 'Gagal menambahkan ke wishlist.'
        });
      }
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: 'Terjadi Kesalahan',
        text: error.message
      });
    }
  }

  // Fungsi ambil data produk dari backend sesuai id
  async function fetchProductById(id) {
    try {
      const res = await fetch(`${apiBase}/products/${id}`);
      if (!res.ok) throw new Error('Produk tidak ditemukan');
      const product = await res.json();
      return product;
    } catch (err) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: err.message
      });
      return null;
    }
  }

  // Main
  document.addEventListener('DOMContentLoaded', async () => {
    const productId = getProductIdFromURL();
    if (!productId) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'ID produk tidak ditemukan di URL.'
      });
      return;
    }
    const product = await fetchProductById(productId);
    if (product) {
      renderProductDetail(product);
    }
  });
</script>

</body>
</html>
